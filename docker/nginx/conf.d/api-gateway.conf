# Upstream definitions (internal service discovery)
upstream auth_service {
    server auth-service:2081;
}

upstream data_service {
    server data-service:2082;
}

upstream upload_service {
    server upload-service:2083;
}

upstream report_service {
    server report-service:2084;
}

# API Gateway Server
server {
    listen 8000;
    server_name _;
    client_max_body_size 100M;

    # Logging
    access_log /var/log/nginx/api-gateway.log main;
    error_log /var/log/nginx/api-gateway-error.log warn;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "API Gateway healthy\n";
        add_header Content-Type text/plain;
    }

    # Auth Service Routes
    location /api/auth/ {
        limit_req zone=auth burst=10 nodelay;
        
        proxy_pass http://auth_service/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
    }

    # Data Service Routes
    location /api/data/ {
        limit_req zone=general burst=20 nodelay;
        
        # Proxy to data-service (preserves full path including /api/data/)
        proxy_pass http://data_service/api/data/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
    }

    # CSV Upload endpoint (DUAL-WRITE: ambos servicios)
    location /api/data/csv/upload {
        limit_req zone=upload burst=3 nodelay;
        
        # Proxy a Upload Service (nuevo)
        proxy_pass http://upload_service/api/upload/csv/upload;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts para uploads grandes
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # NEW: Upload Service routes
    location /api/upload/ {
        limit_req zone=upload burst=3 nodelay;
        
        proxy_pass http://upload_service/api/upload/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # NEW: Report Service routes
    location /api/reports/ {
        limit_req zone=general burst=20 nodelay;
        
        proxy_pass http://report_service/api/reports/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Redirect root to health
    location / {
        return 404;
    }
}
